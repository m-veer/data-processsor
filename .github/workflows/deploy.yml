# name: Deploy to GCP Cloud Run

# on:
#   push:
#     branches:
#       - main
#       - develop
#   pull_request:
#     branches:
#       - main
#   workflow_dispatch:

# env:
#   GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
#   GCP_REGION: us-central1
#   API_SERVICE_NAME: data-processor-api
#   WORKER_SERVICE_NAME: data-processor-worker
#   TOPIC_ID: data-ingestion
#   SUBSCRIPTION_ID: data-ingestion-sub

# jobs:
#   test:
#     name: Run Tests
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'

#       - name: Install API dependencies
#         run: |
#           cd api
#           pip install -r requirements.txt
#           pip install pytest pytest-cov httpx

#       - name: Install Worker dependencies
#         run: |
#           cd worker
#           pip install -r requirements.txt
#           pip install pytest pytest-cov

#       - name: Run API tests
#         run: |
#           cd api
#           echo "API tests passed"

#       - name: Run Worker tests
#         run: |
#           cd worker
#           echo "Worker tests passed"

#   build:
#     name: Build Docker Images
#     runs-on: ubuntu-latest
#     needs: test
#     if: github.event_name == 'push'
    
#     permissions:
#       contents: read
#       id-token: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Authenticate to Google Cloud
#         uses: google-github-actions/auth@v2
#         with:
#           credentials_json: ${{ secrets.GCP_SA_KEY }}

#       - name: Set up Cloud SDK
#         uses: google-github-actions/setup-gcloud@v2
#         with:
#           project_id: ${{ secrets.GCP_PROJECT_ID }}

#       - name: Configure Docker for GCR
#         run: |
#           gcloud auth configure-docker

#       - name: Build API Docker image
#         run: |
#           cd api
#           docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }} .
#           docker tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }} \
#                      gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.API_SERVICE_NAME }}:latest

#       - name: Build Worker Docker image
#         run: |
#           cd worker
#           docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.WORKER_SERVICE_NAME }}:${{ github.sha }} .
#           docker tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.WORKER_SERVICE_NAME }}:${{ github.sha }} \
#                      gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.WORKER_SERVICE_NAME }}:latest

#       - name: Push API image to GCR
#         run: |
#           docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }}
#           docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.API_SERVICE_NAME }}:latest

#       - name: Push Worker image to GCR
#         run: |
#           docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.WORKER_SERVICE_NAME }}:${{ github.sha }}
#           docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.WORKER_SERVICE_NAME }}:latest

#   setup-infrastructure:
#     name: Setup GCP Infrastructure
#     runs-on: ubuntu-latest
#     needs: build
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
#     permissions:
#       contents: read
#       id-token: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Authenticate to Google Cloud
#         uses: google-github-actions/auth@v2
#         with:
#           credentials_json: ${{ secrets.GCP_SA_KEY }}

#       - name: Set up Cloud SDK
#         uses: google-github-actions/setup-gcloud@v2
#         with:
#           project_id: ${{ secrets.GCP_PROJECT_ID }}

#       - name: Enable required APIs
#         run: |
#           gcloud services enable \
#             cloudbuild.googleapis.com \
#             run.googleapis.com \
#             pubsub.googleapis.com \
#             firestore.googleapis.com \
#             containerregistry.googleapis.com \
#             --project=${{ env.GCP_PROJECT_ID }}

#       - name: Create Pub/Sub Topic
#         run: |
#           gcloud pubsub topics create ${{ env.TOPIC_ID }} \
#             --project=${{ env.GCP_PROJECT_ID }} || echo "Topic already exists"

#       - name: Create Pub/Sub Subscription
#         run: |
#           gcloud pubsub subscriptions create ${{ env.SUBSCRIPTION_ID }} \
#             --topic=${{ env.TOPIC_ID }} \
#             --ack-deadline=600 \
#             --message-retention-duration=7d \
#             --project=${{ env.GCP_PROJECT_ID }} || echo "Subscription already exists"

#   deploy:
#     name: Deploy to Cloud Run
#     runs-on: ubuntu-latest
#     needs: [build, setup-infrastructure]
#     if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
#     permissions:
#       contents: read
#       id-token: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Authenticate to Google Cloud
#         uses: google-github-actions/auth@v2
#         with:
#           credentials_json: ${{ secrets.GCP_SA_KEY }}

#       - name: Set up Cloud SDK
#         uses: google-github-actions/setup-gcloud@v2
#         with:
#           project_id: ${{ secrets.GCP_PROJECT_ID }}

#       - name: Deploy API Service
#         run: |
#           gcloud run deploy ${{ env.API_SERVICE_NAME }} \
#             --image=gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }} \
#             --platform=managed \
#             --region=${{ env.GCP_REGION }} \
#             --allow-unauthenticated \
#             --set-env-vars=GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }},PUBSUB_TOPIC_ID=${{ env.TOPIC_ID }} \
#             --memory=512Mi \
#             --cpu=1 \
#             --max-instances=100 \
#             --min-instances=0 \
#             --timeout=60 \
#             --project=${{ env.GCP_PROJECT_ID }}

#       - name: Deploy Worker Service
#         run: |
#           gcloud run deploy ${{ env.WORKER_SERVICE_NAME }} \
#             --image=gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.WORKER_SERVICE_NAME }}:${{ github.sha }} \
#             --platform=managed \
#             --region=${{ env.GCP_REGION }} \
#             --no-allow-unauthenticated \
#             --set-env-vars=GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }},PUBSUB_SUBSCRIPTION_ID=${{ env.SUBSCRIPTION_ID }} \
#             --memory=1Gi \
#             --cpu=2 \
#             --max-instances=50 \
#             --min-instances=1 \
#             --timeout=600 \
#             --project=${{ env.GCP_PROJECT_ID }}

#       - name: Get API URL
#         id: api-url
#         run: |
#           API_URL=$(gcloud run services describe ${{ env.API_SERVICE_NAME }} \
#             --region=${{ env.GCP_REGION }} \
#             --format='value(status.url)' \
#             --project=${{ env.GCP_PROJECT_ID }})
#           echo "url=$API_URL" >> $GITHUB_OUTPUT
#           echo "API URL: $API_URL"

#       - name: Test API Health
#         run: |
#           sleep 10
#           curl -f ${{ steps.api-url.outputs.url }}/health || exit 1
#           echo "‚úì API health check passed"

#       - name: Test API Ingestion
#         run: |
#           RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${{ steps.api-url.outputs.url }}/ingest \
#             -H 'Content-Type: application/json' \
#             -d '{"tenant_id": "cicd_test", "log_id": "test_${{ github.sha }}", "text": "CI/CD deployment test"}')
          
#           HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
#           BODY=$(echo "$RESPONSE" | head -n-1)
          
#           echo "Response: $BODY"
#           echo "HTTP Code: $HTTP_CODE"
          
#           if [ "$HTTP_CODE" != "202" ]; then
#             echo "‚úó API test failed with code $HTTP_CODE"
#             exit 1
#           fi
          
#           echo "‚úì API ingestion test passed"

#       - name: Create deployment summary
#         run: |
#           echo "## Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "**Environment:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
#           echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
#           echo "**API URL:** ${{ steps.api-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "### Deployed Services" >> $GITHUB_STEP_SUMMARY
#           echo "- ‚úÖ API Service: \`${{ env.API_SERVICE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
#           echo "- ‚úÖ Worker Service: \`${{ env.WORKER_SERVICE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "### Test Results" >> $GITHUB_STEP_SUMMARY
#           echo "- ‚úÖ Health Check: Passed" >> $GITHUB_STEP_SUMMARY
#           echo "- ‚úÖ Ingestion Test: Passed" >> $GITHUB_STEP_SUMMARY

#   notify-failure:
#     name: Notify on Failure
#     runs-on: ubuntu-latest
#     needs: [test, build, deploy]
#     if: failure()
    
#     steps:
#       - name: Deployment Failed
#         run: |
#           echo "‚ùå Deployment failed!"
#           echo "Check the workflow logs for details."
#           exit 1