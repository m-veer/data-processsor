name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  TERRAFORM_VERSION: '1.6.0'
  GCP_REGION: us-central1
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Build Docker Images
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Ensure Artifact Registry repository exists
        run: |
          echo "ðŸ“¦ Checking Artifact Registry repository..."
          
          # Try to create repository (will fail if exists, which is fine)
          gcloud artifacts repositories create data-processor \
            --repository-format=docker \
            --location=${{ env.GCP_REGION }} \
            --description="Docker repository for data processor services" \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            2>&1 | tee repo_creation.log
          
          # Check if creation succeeded or already exists
          if grep -q "ALREADY_EXISTS" repo_creation.log || grep -q "Created repository" repo_creation.log; then
            echo "âœ… Repository ready (created or already exists)"
          else
            echo "::warning::Repository creation had unexpected output"
            cat repo_creation.log
          fi
          
          # Verify repository exists
          gcloud artifacts repositories describe data-processor \
            --location=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}
          
          echo "âœ… Artifact Registry repository verified"

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push API Image
        run: |
          cd api
          echo "ðŸ”¨ Building API image..."
          gcloud builds submit \
            --tag ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/data-processor/data-processor-api:${{ github.sha }} \
            --tag ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/data-processor/data-processor-api:latest \
            --timeout=10m \
            --project=${{ secrets.GCP_PROJECT_ID }}
          echo "âœ… API image built and pushed"

      - name: Build and Push Worker Image
        run: |
          cd worker
          echo "ðŸ”¨ Building Worker image..."
          gcloud builds submit \
            --tag ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/data-processor/data-processor-worker:${{ github.sha }} \
            --tag ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/data-processor/data-processor-worker:latest \
            --timeout=10m \
            --project=${{ secrets.GCP_PROJECT_ID }}
          echo "âœ… Worker image built and pushed"

      - name: Verify Images in Registry
        run: |
          echo "ðŸ“¦ Verifying images in Artifact Registry..."
          gcloud artifacts docker images list \
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/data-processor \
            --project=${{ secrets.GCP_PROJECT_ID }}
          echo "âœ… Images verified"

      - name: Build Summary
        run: |
          echo "## ðŸ³ Docker Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API: \`data-processor-api:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Worker: \`data-processor-worker:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Both images tagged as \`latest\` and pushed to Artifact Registry" >> $GITHUB_STEP_SUMMARY

  # Job 2: Deploy with Terraform
  terraform-deploy:
    name: Deploy Infrastructure with Terraform
    runs-on: ubuntu-latest
    needs: build-images
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
          echo "âœ… Terraform initialized"

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          echo "ðŸ“‹ Creating Terraform plan..."
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -out=tfplan
          echo "âœ… Terraform plan created"

      - name: Terraform Apply
        working-directory: ./terraform
        run: |
          echo "ðŸš€ Applying Terraform configuration..."
          terraform apply -auto-approve tfplan
          echo "âœ… Terraform applied successfully"

      - name: Get Deployment Outputs
        id: outputs
        working-directory: ./terraform
        run: |
          API_URL=$(terraform output -raw api_service_url)
          WORKER_NAME=$(terraform output -raw worker_service_name)
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "worker_name=$WORKER_NAME" >> $GITHUB_OUTPUT
          
          echo "API_URL=$API_URL" >> $GITHUB_ENV
          echo "WORKER_NAME=$WORKER_NAME" >> $GITHUB_ENV

      - name: Wait for Services
        run: |
          echo "â³ Waiting 30 seconds for services to stabilize..."
          sleep 30
          echo "âœ… Services should be ready"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API Service: \`data-processor-api\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Worker Service: \`data-processor-worker\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pub/Sub Topic: \`data-ingestion\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pub/Sub Subscription: \`data-ingestion-sub\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ steps.outputs.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY

  # Job 3: Post-Deployment Validation
  post-deployment-tests:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: terraform-deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get API URL
        id: api
        run: |
          API_URL=$(gcloud run services describe data-processor-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)' \
            --project=${{ secrets.GCP_PROJECT_ID }})
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API_URL=$API_URL" >> $GITHUB_ENV

      - name: Install test dependencies
        run: pip install pytest requests

      - name: Create Post-Deployment Tests
        run: |
          cat > test_deployed_api.py << 'EOF'
          """Post-deployment validation tests"""
          import pytest
          import requests
          import os

          API_URL = os.getenv('API_URL')

          class TestDeployedAPI:
              def test_health_check(self):
                  """Test health endpoint"""
                  response = requests.get(f"{API_URL}/health", timeout=10)
                  assert response.status_code == 200
                  data = response.json()
                  assert data['status'] == 'healthy'
                  print(f"âœ… Health check passed: {data}")
              
              def test_json_ingestion(self):
                  """Test JSON ingestion"""
                  response = requests.post(
                      f"{API_URL}/ingest",
                      json={
                          "tenant_id": "deploy_validation",
                          "log_id": "deploy_001",
                          "text": "Post-deployment validation - User 555-0199"
                      },
                      headers={"Content-Type": "application/json"},
                      timeout=10
                  )
                  assert response.status_code == 202
                  data = response.json()
                  assert data['status'] == 'accepted'
                  print(f"âœ… JSON ingestion passed: {data}")
              
              def test_txt_ingestion(self):
                  """Test TXT ingestion"""
                  response = requests.post(
                      f"{API_URL}/ingest",
                      data="Post-deployment TXT validation - Alert 555-1234",
                      headers={
                          "Content-Type": "text/plain",
                          "X-Tenant-ID": "deploy_validation"
                      },
                      timeout=10
                  )
                  assert response.status_code == 202
                  data = response.json()
                  assert data['status'] == 'accepted'
                  print(f"âœ… TXT ingestion passed: {data}")
          EOF

      - name: Run Post-Deployment PyTests
        env:
          API_URL: ${{ env.API_URL }}
        run: |
          pytest test_deployed_api.py -v -s --tb=short
          echo "âœ… All post-deployment tests passed"

      - name: Smoke Test with cURL
        run: |
          echo "ðŸ” Running smoke tests..."
          
          # Test 1: Health
          curl -f ${{ env.API_URL }}/health || exit 1
          echo "âœ… Health check passed"
          
          # Test 2: JSON
          response=$(curl -s -w "\n%{http_code}" -X POST ${{ env.API_URL }}/ingest \
            -H 'Content-Type: application/json' \
            -d '{"tenant_id":"smoke","log_id":"smoke_001","text":"Smoke test"}')
          http_code=$(echo "$response" | tail -n1)
          [ "$http_code" = "202" ] || exit 1
          echo "âœ… JSON ingestion smoke test passed"
          
          # Test 3: TXT
          response=$(curl -s -w "\n%{http_code}" -X POST ${{ env.API_URL }}/ingest \
            -H 'Content-Type: text/plain' \
            -H 'X-Tenant-ID: smoke' \
            -d 'Smoke test TXT')
          http_code=$(echo "$response" | tail -n1)
          [ "$http_code" = "202" ] || exit 1
          echo "âœ… TXT ingestion smoke test passed"

      - name: Check Service Health
        run: |
          echo "ðŸ¥ Checking service health..."
          
          # Check API service
          gcloud run services describe data-processor-api \
            --region=${{ env.GCP_REGION }} \
            --format="value(status.conditions[0].status)" \
            --project=${{ secrets.GCP_PROJECT_ID }}
          
          # Check Worker service
          gcloud run services describe data-processor-worker \
            --region=${{ env.GCP_REGION }} \
            --format="value(status.conditions[0].status)" \
            --project=${{ secrets.GCP_PROJECT_ID }}
          
          echo "âœ… All services healthy"

      - name: Final Summary
        if: success()
        run: |
          echo "## âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Health checks passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JSON ingestion working" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TXT ingestion working" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All services healthy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ env.API_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Test Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Health check" >> $GITHUB_STEP_SUMMARY
          echo "curl ${{ env.API_URL }}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# JSON ingestion" >> $GITHUB_STEP_SUMMARY
          echo "curl -X POST ${{ env.API_URL }}/ingest \\" >> $GITHUB_STEP_SUMMARY
          echo "  -H 'Content-Type: application/json' \\" >> $GITHUB_STEP_SUMMARY
          echo "  -d '{\"tenant_id\":\"test\",\"text\":\"Test message\"}'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Job 4: Rollback on Failure
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [build-images, terraform-deploy, post-deployment-tests]
    if: failure()
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Notify Failure
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more deployment steps failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Possible Actions" >> $GITHUB_STEP_SUMMARY
          echo "1. Check workflow logs for errors" >> $GITHUB_STEP_SUMMARY
          echo "2. Review recent changes" >> $GITHUB_STEP_SUMMARY
          echo "3. Rollback if necessary" >> $GITHUB_STEP_SUMMARY

      - name: Get Previous Revision
        id: previous
        run: |
          # Get previous working revision for API
          PREV_API=$(gcloud run revisions list \
            --service=data-processor-api \
            --region=${{ env.GCP_REGION }} \
            --format="value(name)" \
            --limit=2 \
            --project=${{ secrets.GCP_PROJECT_ID }} | tail -n1)
          echo "previous_api=$PREV_API" >> $GITHUB_OUTPUT
          
          # Get previous working revision for Worker
          PREV_WORKER=$(gcloud run revisions list \
            --service=data-processor-worker \
            --region=${{ env.GCP_REGION }} \
            --format="value(name)" \
            --limit=2 \
            --project=${{ secrets.GCP_PROJECT_ID }} | tail -n1)
          echo "previous_worker=$PREV_WORKER" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Suggest Rollback Command
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Rollback Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback API to previous revision" >> $GITHUB_STEP_SUMMARY
          echo "gcloud run services update-traffic data-processor-api \\" >> $GITHUB_STEP_SUMMARY
          echo "  --to-revisions=${{ steps.previous.outputs.previous_api }}=100 \\" >> $GITHUB_STEP_SUMMARY
          echo "  --region=${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback Worker to previous revision" >> $GITHUB_STEP_SUMMARY
          echo "gcloud run services update-traffic data-processor-worker \\" >> $GITHUB_STEP_SUMMARY
          echo "  --to-revisions=${{ steps.previous.outputs.previous_worker }}=100 \\" >> $GITHUB_STEP_SUMMARY
          echo "  --region=${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY