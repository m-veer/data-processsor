# name: Deploy Worker Service

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'worker/**'
#       - '.github/workflows/deploy-worker.yml'
#   workflow_dispatch:

# env:
#   GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
#   GCP_REGION: us-central1
#   SERVICE_NAME: data-processor-worker
#   PUBSUB_SUBSCRIPTION: data-ingestion-sub

# jobs:
#   deploy-worker:
#     name: Deploy Worker to Cloud Run
#     runs-on: ubuntu-latest
    
#     permissions:
#       contents: read
#       id-token: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Authenticate to Google Cloud
#         uses: google-github-actions/auth@v2
#         with:
#           credentials_json: ${{ secrets.GCP_SA_KEY }}

#       - name: Set up Cloud SDK
#         uses: google-github-actions/setup-gcloud@v2

#       - name: Build and push Docker image
#         run: |
#           cd worker
#           gcloud builds submit \
#             --tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
#             --tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

#       - name: Deploy to Cloud Run
#         run: |
#           gcloud run deploy ${{ env.SERVICE_NAME }} \
#             --image=gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
#             --platform=managed \
#             --region=${{ env.GCP_REGION }} \
#             --no-allow-unauthenticated \
#             --set-env-vars=GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }},PUBSUB_SUBSCRIPTION_ID=${{ env.PUBSUB_SUBSCRIPTION }} \
#             --memory=1Gi \
#             --cpu=2 \
#             --max-instances=50 \
#             --min-instances=1 \
#             --timeout=600