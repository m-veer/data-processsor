# name: Deploy API Service

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'api/**'
#       - '.github/workflows/deploy-api.yml'
#   workflow_dispatch:

# env:
#   GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
#   GCP_REGION: us-central1
#   SERVICE_NAME: data-processor-api
#   PUBSUB_TOPIC: data-ingestion

# jobs:
#   deploy-api:
#     name: Deploy API to Cloud Run
#     runs-on: ubuntu-latest
    
#     permissions:
#       contents: read
#       id-token: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Authenticate to Google Cloud
#         uses: google-github-actions/auth@v2
#         with:
#           credentials_json: ${{ secrets.GCP_SA_KEY }}

#       - name: Set up Cloud SDK
#         uses: google-github-actions/setup-gcloud@v2

#       - name: Build and push Docker image
#         run: |
#           cd api
#           gcloud builds submit \
#             --tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
#             --tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

#       - name: Deploy to Cloud Run
#         run: |
#           gcloud run deploy ${{ env.SERVICE_NAME }} \
#             --image=gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
#             --platform=managed \
#             --region=${{ env.GCP_REGION }} \
#             --allow-unauthenticated \
#             --set-env-vars=GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }},PUBSUB_TOPIC_ID=${{ env.PUBSUB_TOPIC }} \
#             --memory=512Mi \
#             --cpu=1 \
#             --max-instances=100 \
#             --min-instances=0 \
#             --timeout=60

#       - name: Get service URL
#         id: url
#         run: |
#           URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
#             --region=${{ env.GCP_REGION }} \
#             --format='value(status.url)')
#           echo "service_url=$URL" >> $GITHUB_OUTPUT

#       - name: Test deployment
#         run: |
#           curl -f ${{ steps.url.outputs.service_url }}/health