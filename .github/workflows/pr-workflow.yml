name: PR Test - Validation Only

on:
  pull_request:
    branches:
      - main

env:
  PYTHON_VERSION: '3.11'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # Job 1: Code Formatting Check
  format-check:
    name: Code Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install formatting tools
        run: |
          pip install black flake8 isort

      - name: Check Python formatting with Black
        run: |
          black --check api/ worker/
          echo "âœ… Code formatting check passed"

      - name: Lint with flake8
        run: |
          flake8 api/main.py worker/main.py \
            --count \
            --max-line-length=120 \
            --exclude=venv,__pycache__,.pytest_cache \
            --statistics
          echo "âœ… Linting check passed"
        continue-on-error: true

      - name: Check import sorting
        run: |
          isort --check-only api/ worker/
          echo "âœ… Import sorting check passed"
        continue-on-error: true

  # Job 2: PyTest Unit Tests
  pytest-tests:
    name: PyTest Unit Tests
    runs-on: ubuntu-latest
    needs: format-check
    
    strategy:
      matrix:
        service: [api, worker]
        # service: [api]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.service }}-${{ hashFiles(format('{0}/requirements.txt', matrix.service)) }}

      - name: Install dependencies
        run: |
          cd ${{ matrix.service }}
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run PyTest with coverage
        run: |
          cd ${{ matrix.service }}
          pytest tests/ -v \
            --cov=main \
            --cov-report=term \
            --cov-report=xml \
            --cov-report=html \
            --tb=short

      - name: Check coverage threshold
        run: |
          cd ${{ matrix.service }}
          coverage report --fail-under=70
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: ${{ matrix.service }}/htmlcov/

      - name: Display test results
        if: always()
        run: |
          echo "### PyTest Results - ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Unit tests passed" >> $GITHUB_STEP_SUMMARY

  # Job 3: Integration Tests (Local API)
  integration-tests:
    name: API Integration Tests (Local)
    runs-on: ubuntu-latest
    needs: pytest-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install API dependencies
        run: |
          cd api
          pip install -r requirements.txt
          pip install pytest requests

      - name: Start API server in background
        run: |
          cd api
          # Set mock environment variables
          export GCP_PROJECT_ID=test-project
          export PUBSUB_TOPIC_ID=test-topic
          # Start API in background
          nohup python -c "
          from unittest.mock import MagicMock, patch
          import sys
          
          # Mock Pub/Sub before importing main
          mock_publisher = MagicMock()
          mock_publisher.topic_path.return_value = 'projects/test/topics/test'
          mock_future = MagicMock()
          mock_future.result.return_value = 'mock-message-id'
          mock_publisher.publish.return_value = mock_future
          
          with patch('google.cloud.pubsub_v1.PublisherClient', return_value=mock_publisher):
              from main import app
              import uvicorn
              uvicorn.run(app, host='0.0.0.0', port=8080, log_level='info')
          " > api.log 2>&1 &
          
          # Save PID
          echo $! > api.pid
          
          # Wait for API to start
          echo "Waiting for API to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… API started successfully"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Verify API is running
        run: |
          curl -f http://localhost:8080/health || (cat api/api.log && exit 1)
          echo "âœ… API health check passed"

      - name: Create integration test file
        run: |
          mkdir -p tests_integration
          cat > tests_integration/test_local_api.py << 'EOF'
          """
          Integration tests for API endpoints against localhost
          """
          import pytest
          import requests

          API_URL = "http://localhost:8080"

          class TestHealthCheck:
              """Test health check endpoint"""
              
              def test_health_check_returns_200(self):
                  """Test health endpoint returns 200"""
                  response = requests.get(f"{API_URL}/health", timeout=10)
                  assert response.status_code == 200
              
              def test_health_check_structure(self):
                  """Test health endpoint returns correct structure"""
                  response = requests.get(f"{API_URL}/health", timeout=10)
                  
                  assert response.status_code == 200
                  data = response.json()
                  
                  assert 'status' in data
                  assert data['status'] == 'healthy'
                  assert 'timestamp' in data

          class TestJSONIngestion:
              """Test JSON ingestion"""
              
              def test_json_ingestion_valid_payload(self):
                  """Test valid JSON payload"""
                  response = requests.post(
                      f"{API_URL}/ingest",
                      json={
                          "tenant_id": "pytest_local",
                          "log_id": "local_test_001",
                          "text": "Local integration test - User 555-0199"
                      },
                      headers={"Content-Type": "application/json"},
                      timeout=10
                  )
                  
                  assert response.status_code == 202
                  data = response.json()
                  assert data['status'] == 'accepted'
                  assert data['tenant_id'] == 'pytest_local'
                  assert 'message_id' in data
              
              def test_json_missing_tenant_id(self):
                  """Test JSON without tenant_id returns 400"""
                  response = requests.post(
                      f"{API_URL}/ingest",
                      json={"log_id": "test", "text": "Missing tenant"},
                      headers={"Content-Type": "application/json"},
                      timeout=10
                  )
                  assert response.status_code == 400

          class TestTXTIngestion:
              """Test TXT ingestion"""
              
              def test_txt_ingestion_valid_payload(self):
                  """Test valid TXT payload"""
                  response = requests.post(
                      f"{API_URL}/ingest",
                      data="Local TXT test - Alert 555-1234",
                      headers={
                          "Content-Type": "text/plain",
                          "X-Tenant-ID": "pytest_local"
                      },
                      timeout=10
                  )
                  
                  assert response.status_code == 202
                  data = response.json()
                  assert data['status'] == 'accepted'
                  assert data['tenant_id'] == 'pytest_local'
              
              def test_txt_missing_tenant_header(self):
                  """Test TXT without X-Tenant-ID returns 400"""
                  response = requests.post(
                      f"{API_URL}/ingest",
                      data="Missing tenant header",
                      headers={"Content-Type": "text/plain"},
                      timeout=10
                  )
                  assert response.status_code == 400

          class TestErrorHandling:
              """Test error handling"""
              
              def test_unsupported_content_type(self):
                  """Test unsupported content type returns 415"""
                  response = requests.post(
                      f"{API_URL}/ingest",
                      data="test",
                      headers={"Content-Type": "application/xml"},
                      timeout=10
                  )
                  assert response.status_code == 415
          EOF

      - name: Run Integration Tests
        run: |
          pytest tests_integration/test_local_api.py -v --tb=short
          echo "âœ… Integration tests completed"

      - name: Stop API server
        if: always()
        run: |
          if [ -f api/api.pid ]; then
            kill $(cat api/api.pid) || true
            rm api/api.pid
          fi
          echo "âœ… API server stopped"

      - name: Show API logs on failure
        if: failure()
        run: |
          echo "ðŸ“‹ API Server Logs:"
          cat api/api.log || echo "No logs found"

      - name: Integration Test Summary
        if: always()
        run: |
          echo "### ðŸ§ª Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tested against local API (mocked Pub/Sub)" >> $GITHUB_STEP_SUMMARY
          echo "- Health check, JSON ingestion, TXT ingestion validated" >> $GITHUB_STEP_SUMMARY

  # Job 4: Terraform Format Check
  terraform-format:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    needs: format-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: ./terraform
        run: |
          terraform fmt -check -recursive
          if [ $? -eq 0 ]; then
            echo "âœ… Terraform files are properly formatted"
          else
            echo "::error::Terraform files need formatting. Run 'terraform fmt -recursive'"
            exit 1
          fi

      - name: Format Check Summary
        run: |
          echo "### âœ… Terraform Format Check" >> $GITHUB_STEP_SUMMARY
          echo "All Terraform files are properly formatted" >> $GITHUB_STEP_SUMMARY

  # Job 5: Terraform Validate
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: terraform-format
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init -backend=false
          echo "âœ… Terraform initialized"

      - name: Terraform Validate
        working-directory: ./terraform
        run: |
          terraform validate
          echo "âœ… Terraform configuration is valid"

      - name: Terraform Plan (Validation Only)
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -out=tfplan-validation
          echo "âœ… Terraform plan generated successfully"

      - name: Validation Summary
        run: |
          echo "### âœ… Terraform Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Format: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Init: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Validate: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Plan: Generated successfully" >> $GITHUB_STEP_SUMMARY

  # Job 6: Final PR Summary
  pr-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [format-check, pytest-tests, integration-tests, terraform-format, terraform-validate]
    if: always()
    
    steps:
      - name: Check if all jobs passed
        run: |
          echo "## ðŸ“‹ PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code formatting validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PyTest unit tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Integration tests completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform format checked" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Ready to Merge" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed! This PR is ready to be merged to main." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Deployment will occur automatically after merge." >> $GITHUB_STEP_SUMMARY